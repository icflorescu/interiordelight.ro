(function(){function k(e,t,n){if(e===t)return e!==0||1/e==1/t;if(e==null||t==null)return e===t;e._chain&&(e=e._wrapped),t._chain&&(t=t._wrapped);if(e.isEqual&&x.isFunction(e.isEqual))return e.isEqual(t);if(t.isEqual&&x.isFunction(t.isEqual))return t.isEqual(e);var r=f.call(e);if(r!=f.call(t))return!1;switch(r){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:e==0?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if(typeof e!="object"||typeof t!="object")return!1;var i=n.length;while(i--)if(n[i]==e)return!0;n.push(e);var s=0,o=!0;if(r=="[object Array]"){s=e.length,o=s==t.length;if(o)while(s--)if(!(o=s in e==s in t&&k(e[s],t[s],n)))break}else{if("constructor"in e!="constructor"in t||e.constructor!=t.constructor)return!1;for(var u in e)if(x.has(e,u)){s++;if(!(o=x.has(t,u)&&k(e[u],t[u],n)))break}if(o){for(u in t)if(x.has(t,u)&&!(s--))break;o=!s}}return n.pop(),o}var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.push,u=r.slice,a=r.unshift,f=i.toString,l=i.hasOwnProperty,c=r.forEach,h=r.map,p=r.reduce,d=r.reduceRight,v=r.filter,m=r.every,g=r.some,y=r.indexOf,b=r.lastIndexOf,w=Array.isArray,E=Object.keys,S=s.bind,x=function(e){return new j(e)};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=x),exports._=x):e._=x,x.VERSION="1.3.3";var T=x.each=x.forEach=function(e,t,r){if(e==null)return;if(c&&e.forEach===c)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(t.call(r,e[i],i,e)===n)return}else for(var o in e)if(x.has(e,o)&&t.call(r,e[o],o,e)===n)return};x.map=x.collect=function(e,t,n){var r=[];return e==null?r:h&&e.map===h?e.map(t,n):(T(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),r)},x.reduce=x.foldl=x.inject=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(p&&e.reduce===p)return r&&(t=x.bind(t,r)),i?e.reduce(t,n):e.reduce(t);T(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)});if(!i)throw new TypeError("Reduce of empty array with no initial value");return n},x.reduceRight=x.foldr=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(d&&e.reduceRight===d)return r&&(t=x.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=x.toArray(e).reverse();return r&&!i&&(t=x.bind(t,r)),i?x.reduce(s,t,n,r):x.reduce(s,t)},x.find=x.detect=function(e,t,n){var r;return N(e,function(e,i,s){if(t.call(n,e,i,s))return r=e,!0}),r},x.filter=x.select=function(e,t,n){var r=[];return e==null?r:v&&e.filter===v?e.filter(t,n):(T(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},x.reject=function(e,t,n){var r=[];return e==null?r:(T(e,function(e,i,s){t.call(n,e,i,s)||(r[r.length]=e)}),r)},x.every=x.all=function(e,t,r){var i=!0;return e==null?i:m&&e.every===m?e.every(t,r):(T(e,function(e,s,o){if(!(i=i&&t.call(r,e,s,o)))return n}),!!i)};var N=x.some=x.any=function(e,t,r){t||(t=x.identity);var i=!1;return e==null?i:g&&e.some===g?e.some(t,r):(T(e,function(e,s,o){if(i||(i=t.call(r,e,s,o)))return n}),!!i)};x.include=x.contains=function(e,t){var n=!1;return e==null?n:y&&e.indexOf===y?e.indexOf(t)!=-1:(n=N(e,function(e){return e===t}),n)},x.invoke=function(e,t){var n=u.call(arguments,2);return x.map(e,function(e){return(x.isFunction(t)?t||e:e[t]).apply(e,n)})},x.pluck=function(e,t){return x.map(e,function(e){return e[t]})},x.max=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.max.apply(Math,e);if(!t&&x.isEmpty(e))return-Infinity;var r={computed:-Infinity};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},x.min=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.min.apply(Math,e);if(!t&&x.isEmpty(e))return Infinity;var r={computed:Infinity};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o<r.computed&&(r={value:e,computed:o})}),r.value},x.shuffle=function(e){var t=[],n;return T(e,function(e,r,i){n=Math.floor(Math.random()*(r+1)),t[r]=t[n],t[n]=e}),t},x.sortBy=function(e,t,n){var r=x.isFunction(t)?t:function(e){return e[t]};return x.pluck(x.map(e,function(e,t,i){return{value:e,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;return n===void 0?1:r===void 0?-1:n<r?-1:n>r?1:0}),"value")},x.groupBy=function(e,t){var n={},r=x.isFunction(t)?t:function(e){return e[t]};return T(e,function(e,t){var i=r(e,t);(n[i]||(n[i]=[])).push(e)}),n},x.sortedIndex=function(e,t,n){n||(n=x.identity);var r=n(t),i=0,s=e.length;while(i<s){var o=i+s>>1;n(e[o])<r?i=o+1:s=o}return i},x.toArray=function(e){return e?x.isArray(e)?u.call(e):x.isArguments(e)?u.call(e):e.toArray&&x.isFunction(e.toArray)?e.toArray():x.values(e):[]},x.size=function(e){return x.isArray(e)?e.length:x.keys(e).length},x.first=x.head=x.take=function(e,t,n){return t!=null&&!n?u.call(e,0,t):e[0]},x.initial=function(e,t,n){return u.call(e,0,e.length-(t==null||n?1:t))},x.last=function(e,t,n){return t!=null&&!n?u.call(e,Math.max(e.length-t,0)):e[e.length-1]},x.rest=x.tail=function(e,t,n){return u.call(e,t==null||n?1:t)},x.compact=function(e){return x.filter(e,function(e){return!!e})},x.flatten=function(e,t){return function n(e,r){return T(e,function(e){x.isArray(e)?t?o.apply(r,e):n(e,r):r.push(e)}),r}(e,[])},x.without=function(e){return x.difference(e,u.call(arguments,1))},x.uniq=x.unique=function(e,t,n){var r=n?x.map(e,n):e,i=[];return e.length<3&&(t=!0),x.reduce(r,function(n,r,s){if(t?x.last(n)!==r||!n.length:!x.include(n,r))n.push(r),i.push(e[s]);return n},[]),i},x.union=function(){return x.uniq(x.flatten(arguments,!0))},x.intersection=function(e){var t=u.call(arguments,1);return x.filter(x.uniq(e),function(e){return x.every(t,function(t){return x.indexOf(t,e)>=0})})},x.difference=function(e){var t=x.flatten(u.call(arguments,1),!0);return x.filter(e,function(e){return!x.include(t,e)})},x.zip=function(){var e=u.call(arguments),t=x.max(x.pluck(e,"length")),n=new Array(t);for(var r=0;r<t;r++)n[r]=x.pluck(e,""+r);return n},x.indexOf=function(e,t,n){if(e==null)return-1;var r,i;if(n)return r=x.sortedIndex(e,t),e[r]===t?r:-1;if(y&&e.indexOf===y)return e.indexOf(t);for(r=0,i=e.length;r<i;r++)if(e[r]===t)return r;return-1},x.lastIndexOf=function(e,t){if(e==null)return-1;if(b&&e.lastIndexOf===b)return e.lastIndexOf(t);var n=e.length;while(n--)if(e[n]===t)return n;return-1},x.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=arguments[2]||1;var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=new Array(r);while(i<r)s[i++]=e,e+=n;return s};var C=function(){};x.bind=function(t,n){var r,i;if(t.bind===S&&S)return S.apply(t,u.call(arguments,1));if(!x.isFunction(t))throw new TypeError;return i=u.call(arguments,2),r=function(){if(this instanceof r){C.prototype=t.prototype;var e=new C,s=t.apply(e,i.concat(u.call(arguments)));return Object(s)===s?s:e}return t.apply(n,i.concat(u.call(arguments)))}},x.bindAll=function(e){var t=u.call(arguments,1);return t.length==0&&(t=x.functions(e)),T(t,function(t){e[t]=x.bind(e[t],e)}),e},x.memoize=function(e,t){var n={};return t||(t=x.identity),function(){var r=t.apply(this,arguments);return x.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},x.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},x.defer=function(e){return x.delay.apply(x,[e,1].concat(u.call(arguments,1)))},x.throttle=function(e,t){var n,r,i,s,o,u,a=x.debounce(function(){o=s=!1},t);return function(){n=this,r=arguments;var f=function(){i=null,o&&e.apply(n,r),a()};return i||(i=setTimeout(f,t)),s?o=!0:(s=!0,u=e.apply(n,r)),a(),u}},x.debounce=function(e,t,n){var r;return function(){var i=this,s=arguments,o=function(){r=null,n||e.apply(i,s)},u=n&&!r;clearTimeout(r),r=setTimeout(o,t),u&&e.apply(i,s)}},x.once=function(e){var t=!1,n;return function(){return t?n:(t=!0,n=e.apply(this,arguments))}},x.wrap=function(e,t){return function(){var n=[e].concat(u.call(arguments,0));return t.apply(this,n)}},x.compose=function(){var e=arguments;return function(){var t=arguments;for(var n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},x.after=function(e,t){return e<=0?t():function(){if(--e<1)return t.apply(this,arguments)}},x.keys=E||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)x.has(e,n)&&(t[t.length]=n);return t},x.values=function(e){return x.map(e,x.identity)},x.functions=x.methods=function(e){var t=[];for(var n in e)x.isFunction(e[n])&&t.push(n);return t.sort()},x.extend=function(e){return T(u.call(arguments,1),function(t){for(var n in t)e[n]=t[n]}),e},x.pick=function(e){var t={};return T(x.flatten(u.call(arguments,1)),function(n){n in e&&(t[n]=e[n])}),t},x.defaults=function(e){return T(u.call(arguments,1),function(t){for(var n in t)e[n]==null&&(e[n]=t[n])}),e},x.clone=function(e){return x.isObject(e)?x.isArray(e)?e.slice():x.extend({},e):e},x.tap=function(e,t){return t(e),e},x.isEqual=function(e,t){return k(e,t,[])},x.isEmpty=function(e){if(e==null)return!0;if(x.isArray(e)||x.isString(e))return e.length===0;for(var t in e)if(x.has(e,t))return!1;return!0},x.isElement=function(e){return!!e&&e.nodeType==1},x.isArray=w||function(e){return f.call(e)=="[object Array]"},x.isObject=function(e){return e===Object(e)},x.isArguments=function(e){return f.call(e)=="[object Arguments]"},x.isArguments(arguments)||(x.isArguments=function(e){return!!e&&!!x.has(e,"callee")}),x.isFunction=function(e){return f.call(e)=="[object Function]"},x.isString=function(e){return f.call(e)=="[object String]"},x.isNumber=function(e){return f.call(e)=="[object Number]"},x.isFinite=function(e){return x.isNumber(e)&&isFinite(e)},x.isNaN=function(e){return e!==e},x.isBoolean=function(e){return e===!0||e===!1||f.call(e)=="[object Boolean]"},x.isDate=function(e){return f.call(e)=="[object Date]"},x.isRegExp=function(e){return f.call(e)=="[object RegExp]"},x.isNull=function(e){return e===null},x.isUndefined=function(e){return e===void 0},x.has=function(e,t){return l.call(e,t)},x.noConflict=function(){return e._=t,this},x.identity=function(e){return e},x.times=function(e,t,n){for(var r=0;r<e;r++)t.call(n,r)};var L={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"},A=/[&<>"'\/]/g;x.escape=function(e){return(""+e).replace(A,function(e){return L[e]})},x.result=function(e,t){if(e==null)return null;var n=e[t];return x.isFunction(n)?n.call(e):n},x.mixin=function(e){T(x.functions(e),function(t){I(t,x[t]=e[t])})};var O=0;x.uniqueId=function(e){var t=O++;return e?e+t:t},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var M=/.^/,_={"\\":"\\","'":"'",r:"\r",n:"\n",t:"	",u2028:"\u2028",u2029:"\u2029"};for(var D in _)_[_[D]]=D;var P=/\\|'|\r|\n|\t|\u2028|\u2029/g,H=/\\(\\|'|r|n|t|u2028|u2029)/g,B=function(e){return e.replace(H,function(e,t){return _[t]})};x.template=function(e,t,n){n=x.defaults(n||{},x.templateSettings);var r="__p+='"+e.replace(P,function(e){return"\\"+_[e]}).replace(n.escape||M,function(e,t){return"'+\n((__t=("+B(t)+"))==null?'':_.escape(__t))+\n'"}).replace(n.interpolate||M,function(e,t){return"'+\n((__t=("+B(t)+"))==null?'':__t)+\n'"}).replace(n.evaluate||M,function(e,t){return"';\n"+B(t)+"\n__p+='"})+"';\n";n.variable||(r="with(obj||{}){\n"+r+"}\n"),r="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'')};\n"+r+"return __p;\n";var i=new Function(n.variable||"obj","_",r);if(t)return i(t,x);var s=function(e){return i.call(this,e,x)};return s.source="function("+(n.variable||"obj")+"){\n"+r+"}",s},x.chain=function(e){return x(e).chain()};var j=function(e){this._wrapped=e};x.prototype=j.prototype;var F=function(e,t){return t?x(e).chain():e},I=function(e,t){j.prototype[e]=function(){var e=u.call(arguments);return a.call(e,this._wrapped),F(t.apply(x,e),this._chain)}};x.mixin(x),T(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];j.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),(e=="shift"||e=="splice")&&n.length===0&&delete n[0],F(n,this._chain)}}),T(["concat","join","slice"],function(e){var t=r[e];j.prototype[e]=function(){return F(t.apply(this._wrapped,arguments),this._chain)}}),j.prototype.chain=function(){return this._chain=!0,this},j.prototype.value=function(){return this._wrapped}}).call(this),function(){var e=this,t=e.Backbone,n=Array.prototype.splice,r;typeof exports!="undefined"?r=exports:r=e.Backbone={},r.VERSION="0.9.2";var i=e._;!i&&typeof require!="undefined"&&(i=require("underscore")),r.$=e.jQuery||e.Zepto||e.ender,r.noConflict=function(){return e.Backbone=t,this},r.emulateHTTP=!1,r.emulateJSON=!1;var s=/\s+/,o=r.Events={on:function(e,t,n){var r,i,o;if(!t)return this;e=e.split(s),r=this._callbacks||(this._callbacks={});while(i=e.shift())o=r[i]||(r[i]=[]),o.push(t,n);return this},off:function(e,t,n){var r,o,u,a;if(!(o=this._callbacks))return this;if(!(e||t||n))return delete this._callbacks,this;e=e?e.split(s):i.keys(o);while(r=e.shift()){if(!(u=o[r])||!t&&!n){delete o[r];continue}for(a=u.length-2;a>=0;a-=2)t&&u[a]!==t||n&&u[a+1]!==n||u.splice(a,2)}return this},trigger:function(e){var t,n,r,i,o,u,a,f;if(!(n=this._callbacks))return this;f=[],e=e.split(s);for(i=1,o=arguments.length;i<o;i++)f[i-1]=arguments[i];while(t=e.shift()){if(a=n.all)a=a.slice();if(r=n[t])r=r.slice();if(r)for(i=0,o=r.length;i<o;i+=2)r[i].apply(r[i+1]||this,f);if(a){u=[t].concat(f);for(i=0,o=a.length;i<o;i+=2)a[i].apply(a[i+1]||this,u)}}return this}};o.bind=o.on,o.unbind=o.off;var u=r.Model=function(e,t){var n;e||(e={}),t&&t.parse&&(e=this.parse(e));if(n=T(this,"defaults"))e=i.extend({},n,e);t&&t.collection&&(this.collection=t.collection),this.attributes={},this._escapedAttributes={},this.cid=i.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(e,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=i.clone(this.attributes),this.initialize.apply(this,arguments)};i.extend(u.prototype,o,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(e){return i.clone(this.attributes)},get:function(e){return this.attributes[e]},escape:function(e){var t;if(t=this._escapedAttributes[e])return t;var n=this.get(e);return this._escapedAttributes[e]=i.escape(n==null?"":""+n)},has:function(e){return this.get(e)!=null},set:function(e,t,n){var r,s,o;i.isObject(e)||e==null?(r=e,n=t):(r={},r[e]=t),n||(n={});if(!r)return this;r instanceof u&&(r=r.attributes);if(n.unset)for(s in r)r[s]=void 0;if(!this._validate(r,n))return!1;this.idAttribute in r&&(this.id=r[this.idAttribute]);var a=n.changes={},f=this.attributes,l=this._escapedAttributes,c=this._previousAttributes||{};for(s in r){o=r[s];if(!i.isEqual(f[s],o)||n.unset&&i.has(f,s))delete l[s],(n.silent?this._silent:a)[s]=!0;n.unset?delete f[s]:f[s]=o,!i.isEqual(c[s],o)||i.has(f,s)!=i.has(c,s)?(this.changed[s]=o,n.silent||(this._pending[s]=!0)):(delete this.changed[s],delete this._pending[s])}return n.silent||this.change(n),this},unset:function(e,t){return t=i.extend({},t,{unset:!0}),this.set(e,null,t)},clear:function(e){return e=i.extend({},e,{unset:!0}),this.set(i.clone(this.attributes),e)},fetch:function(e){e=e?i.clone(e):{};var t=this,n=e.success;return e.success=function(r,i,s){if(!t.set(t.parse(r,s),e))return!1;n&&n(t,r)},e.error=r.wrapError(e.error,t,e),(this.sync||r.sync).call(this,"read",this,e)},save:function(e,t,n){var s,o;i.isObject(e)||e==null?(s=e,n=t):(s={},s[e]=t),n=n?i.clone(n):{};if(n.wait){if(!this._validate(s,n))return!1;o=i.clone(this.attributes)}var u=i.extend({},n,{silent:!0});if(s&&!this.set(s,n.wait?u:n))return!1;var a=this,f=n.success;n.success=function(e,t,r){var o=a.parse(e,r);n.wait&&(delete n.wait,o=i.extend(s||{},o));if(!a.set(o,n))return!1;f?f(a,e):a.trigger("sync",a,e,n)},n.error=r.wrapError(n.error,a,n);var l=this.isNew()?"create":"update",c=(this.sync||r.sync).call(this,l,this,n);return n.wait&&this.clear(u).set(o,u),c},destroy:function(e){e=e?i.clone(e):{};var t=this,n=e.success,s=function(){t.trigger("destroy",t,t.collection,e)};if(this.isNew())return s(),!1;e.success=function(r){e.wait&&s(),n?n(t,r):t.trigger("sync",t,r,e)},e.error=r.wrapError(e.error,t,e);var o=(this.sync||r.sync).call(this,"delete",this,e);return e.wait||s(),o},url:function(){var e=T(this,"urlRoot")||T(this.collection,"url")||N();return this.isNew()?e:e+(e.charAt(e.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},change:function(e){e||(e={});var t=this._changing;this._changing=!0;for(var n in this._silent)this._pending[n]=!0;var r=i.extend({},e.changes,this._silent);this._silent={};for(var n in r)this.trigger("change:"+n,this,this.get(n),e);if(t)return this;while(!i.isEmpty(this._pending)){this._pending={},this.trigger("change",this,e);for(var n in this.changed){if(this._pending[n]||this._silent[n])continue;delete this.changed[n]}this._previousAttributes=i.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(e){return e==null?!i.isEmpty(this.changed):i.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?i.clone(this.changed):!1;var t,n=!1,r=this._previousAttributes;for(var s in e){if(i.isEqual(r[s],t=e[s]))continue;(n||(n={}))[s]=t}return n},previous:function(e){return e==null||!this._previousAttributes?null:this._previousAttributes[e]},previousAttributes:function(){return i.clone(this._previousAttributes)},isValid:function(){return!this.validate||!this.validate(this.attributes)},_validate:function(e,t){if(t.silent||!this.validate)return!0;e=i.extend({},this.attributes,e);var n=this.validate(e,t);return n?(t&&t.error?t.error(this,n,t):this.trigger("error",this,n,t),!1):!0}});var a=r.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,{silent:!0,parse:t.parse})};i.extend(a.prototype,o,{model:u,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},add:function(e,t){var r,s,o,u,a,f,l={},c={},h=[];t||(t={}),e=i.isArray(e)?e.slice():[e];for(r=0,o=e.length;r<o;r++){if(!(u=e[r]=this._prepareModel(e[r],t)))throw new Error("Can't add an invalid model to a collection");a=u.cid,f=u.id;if(l[a]||this._byCid[a]||f!=null&&(c[f]||this._byId[f])){h.push(r);continue}l[a]=c[f]=u}r=h.length;while(r--)h[r]=e.splice(h[r],1)[0];for(r=0,o=e.length;r<o;r++)(u=e[r]).on("all",this._onModelEvent,this),this._byCid[u.cid]=u,u.id!=null&&(this._byId[u.id]=u);this.length+=o,s=t.at!=null?t.at:this.models.length,n.apply(this.models,[s,0].concat(e)),this.comparator&&t.at==null&&this.sort({silent:!0});if(t.silent)return this;for(r=0,o=this.models.length;r<o;r++){if(!l[(u=this.models[r]).cid])continue;t.index=r,u.trigger("add",u,this,t)}if(t.merge)for(r=0,o=h.length;r<o;r++)(u=this._byId[h[r].id])&&u.set(h[r],t);return this},remove:function(e,t){var n,r,s,o;t||(t={}),e=i.isArray(e)?e.slice():[e];for(n=0,r=e.length;n<r;n++){o=this.getByCid(e[n])||this.get(e[n]);if(!o)continue;delete this._byId[o.id],delete this._byCid[o.cid],s=this.indexOf(o),this.models.splice(s,1),this.length--,t.silent||(t.index=s,o.trigger("remove",o,this,t)),this._removeReference(o)}return this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,t),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,i.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},get:function(e){return e==null?void 0:this._byId[e.id!=null?e.id:e]},getByCid:function(e){return e&&this._byCid[e.cid||e]},at:function(e){return this.models[e]},where:function(e){return i.isEmpty(e)?[]:this.filter(function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0})},sort:function(e){e||(e={});if(!this.comparator)throw new Error("Cannot sort a set without a comparator");var t=i.bind(this.comparator,this);return this.comparator.length==1?this.models=this.sortBy(t):this.models.sort(t),e.silent||this.trigger("reset",this,e),this},pluck:function(e){return i.map(this.models,function(t){return t.get(e)})},reset:function(e,t){e||(e=[]),t||(t={});for(var n=0,r=this.models.length;n<r;n++)this._removeReference(this.models[n]);return this._reset(),this.add(e,i.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},fetch:function(e){e=e?i.clone(e):{},e.parse===undefined&&(e.parse=!0);var t=this,n=e.success;return e.success=function(r,i,s){t[e.add?"add":"reset"](t.parse(r,s),e),n&&n(t,r)},e.error=r.wrapError(e.error,t,e),(this.sync||r.sync).call(this,"read",this,e)},create:function(e,t){var n=this;t=t?i.clone(t):{},e=this._prepareModel(e,t);if(!e)return!1;t.wait||n.add(e,t);var r=t.success;return t.success=function(i,s,o){t.wait&&n.add(i,t),r?r(i,s):i.trigger("sync",e,s,t)},e.save(null,t),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models)},chain:function(){return i(this.models).chain()},_reset:function(e){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(e,t){if(e instanceof u)return e.collection||(e.collection=this),e;t||(t={}),t.collection=this;var n=new this.model(e,t);return n._validate(n.attributes,t)?n:!1},_removeReference:function(e){this==e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){if((e=="add"||e=="remove")&&n!=this)return;e=="destroy"&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],t.id!=null&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments)}});var f=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];i.each(f,function(e){a.prototype[e]=function(){return i[e].apply(i,[this.models].concat(i.toArray(arguments)))}});var l=r.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},c=/:\w+/g,h=/\*\w+/g,p=/[-[\]{}()+?.,\\^$|#\s]/g;i.extend(l.prototype,o,{initialize:function(){},route:function(e,t,n){return r.history||(r.history=new d),i.isRegExp(e)||(e=this._routeToRegExp(e)),n||(n=this[t]),r.history.route(e,i.bind(function(i){var s=this._extractParameters(e,i);n&&n.apply(this,s),this.trigger.apply(this,["route:"+t].concat(s)),r.history.trigger("route",this,t,s)},this)),this},navigate:function(e,t){r.history.navigate(e,t)},_bindRoutes:function(){if(!this.routes)return;var e=[];for(var t in this.routes)e.unshift([t,this.routes[t]]);for(var n=0,r=e.length;n<r;n++)this.route(e[n][0],e[n][1],this[e[n][1]])},_routeToRegExp:function(e){return e=e.replace(p,"\\$&").replace(c,"([^/]+)").replace(h,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){return e.exec(t).slice(1)}});var d=r.History=function(){this.handlers=[],i.bindAll(this,"checkUrl")},v=/^[#\/]/,m=/msie [\w.]+/;d.started=!1,i.extend(d.prototype,o,{interval:50,getHash:function(e){var t=e?e.location:window.location,n=t.href.match(/#(.*)$/);return n?n[1]:""},getFragment:function(e,t){return e==null&&(this._hasPushState||!this._wantsHashChange||t?e=window.location.pathname:e=this.getHash()),e.indexOf(this.options.root)||(e=e.substr(this.options.root.length)),e.replace(v,"")},start:function(e){if(d.started)throw new Error("Backbone.history has already been started");d.started=!0,this.options=i.extend({},{root:"/"},this.options,e),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var t=this.getFragment(),n=document.documentMode,s=m.exec(navigator.userAgent.toLowerCase())&&(!n||n<=7);s&&this._wantsHashChange&&(this.iframe=r.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(t)),this._hasPushState?r.$(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!s?r.$(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=t;var o=window.location,u=o.pathname==this.options.root&&!o.search;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!u)return this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+window.location.search+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&u&&o.hash&&(this.fragment=this.getHash().replace(v,""),window.history.replaceState({},document.title,o.protocol+"//"+o.host+this.options.root+this.fragment));if(!this.options.silent)return this.loadUrl()},stop:function(){r.$(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),d.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();t==this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe)));if(t==this.fragment)return!1;this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(e){var t=this.fragment=this.getFragment(e),n=i.any(this.handlers,function(e){if(e.route.test(t))return e.callback(t),!0});return n},navigate:function(e,t){if(!d.started)return!1;if(!t||t===!0)t={trigger:t};var n=(e||"").replace(v,"");if(this.fragment==n)return;var r=(n.indexOf(this.options.root)!=0?this.options.root:"")+n;if(this._hasPushState)this.fragment=r,window.history[t.replace?"replaceState":"pushState"]({},document.title,r);else{if(!this._wantsHashChange)return window.location.assign(r);this.fragment=n,this._updateHash(window.location,n,t.replace),this.iframe&&n!=this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,n,t.replace))}t.trigger&&this.loadUrl(e)},_updateHash:function(e,t,n){n?e.replace(e.toString().replace(/(javascript:|#).*$/,"")+"#"+t):e.hash=t}});var g=r.View=function(e){this.cid=i.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},y=/^(\S+)\s*(.*)$/,b=["model","collection","el","id","attributes","className","tagName"];i.extend(g.prototype,o,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(e,t,n){var i=document.createElement(e);return t&&r.$(i).attr(t),n!=null&&r.$(i).html(n),i},setElement:function(e,t){return this.$el&&this.undelegateEvents(),this.$el=e instanceof r.$?e:r.$(e),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=T(this,"events")))return;this.undelegateEvents();for(var t in e){var n=e[t];i.isFunction(n)||(n=this[e[t]]);if(!n)throw new Error('Method "'+e[t]+'" does not exist');var r=t.match(y),s=r[1],o=r[2];n=i.bind(n,this),s+=".delegateEvents"+this.cid,o===""?this.$el.bind(s,n):this.$el.delegate(o,s,n)}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(e){this.options&&(e=i.extend({},this.options,e));for(var t=0,n=b.length;t<n;t++){var r=b[t];e[r]&&(this[r]=e[r])}this.options=e},_ensureElement:function(){if(!this.el){var e=i.extend({},T(this,"attributes"));this.id&&(e.id=this.id),this.className&&(e["class"]=this.className),this.setElement(this.make(T(this,"tagName"),e),!1)}else this.setElement(this.el,!1)}});var w=function(e,t){var n=x(this,e,t);return n.extend=this.extend,n};u.extend=a.extend=l.extend=g.extend=w;var E={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};r.sync=function(e,t,n){var s=E[e];n||(n={});var o={type:s,dataType:"json"};return n.url||(o.url=T(t,"url")||N()),!n.data&&t&&(e=="create"||e=="update")&&(o.contentType="application/json",o.data=JSON.stringify(t)),r.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{model:o.data}:{}),r.emulateHTTP&&(s==="PUT"||s==="DELETE")&&(r.emulateJSON&&(o.data._method=s),o.type="POST",o.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",s)}),o.type!=="GET"&&!r.emulateJSON&&(o.processData=!1),r.ajax(i.extend(o,n))},r.ajax=function(){return r.$.ajax.apply(r.$,arguments)},r.wrapError=function(e,t,n){return function(r,i){i=r===t?i:r,e?e(t,i,n):t.trigger("error",t,i,n)}};var S=function(){},x=function(e,t,n){var r;return t&&t.hasOwnProperty("constructor")?r=t.constructor:r=function(){e.apply(this,arguments)},i.extend(r,e),S.prototype=e.prototype,r.prototype=new S,t&&i.extend(r.prototype,t),n&&i.extend(r,n),r.prototype.constructor=r,r.__super__=e.prototype,r},T=function(e,t){return!e||!e[t]?null:i.isFunction(e[t])?e[t]():e[t]},N=function(){throw new Error('A "url" property or function must be specified')}}.call(this),function(e){function t(e){var n={};for(var r in e){var i=e[r];if(i&&i.constructor===Object&&!_.isEmpty(i)){var s=t(i);for(var o in s){var u=s[o];n[r+"."+o]=u}}else n[r]=i}return n}function n(e,t,n){var r=t.split("."),i=e;n||(n=!1);for(var s=0,o=r.length;s<o;s++){if(n&&!_.has(i,r[s]))return!1;i=i[r[s]];if(typeof i=="undefined")return n?!0:i}return n?!0:i}function r(e,t,n,r){r=r||{};var i=t.split("."),s=e;for(var o=0,u=i.length;o<u;o++){var a=i[o];o===u-1?r.unset?delete s[a]:s[a]=n:(typeof s[a]=="undefined"&&(s[a]={}),s=s[a])}}function i(e,t){r(e,t,null,{unset:!0})}var s=e.Model.extend({get:function(e){return n(this.attributes,e)},set:function(s,o,u){var a=e.Model,f,l,c;_.isObject(s)||s==null?(f=s,u=o):(f={},f[s]=o),u||(u={});if(!f)return this;f instanceof a&&(f=f.attributes);if(u.unset)for(l in f)f[l]=void 0;if(!this._validate(f,u))return!1;this.idAttribute in f&&(this.id=f[this.idAttribute]);var h=u.changes={},p=this.attributes,d=this._escapedAttributes,v=this._previousAttributes||{};f=t(f);for(l in f){c=f[l];var m=n(p,l),g=n(v,l),y=n(d,l),b=_.isUndefined(m),w=_.isUndefined(g);if(!_.isEqual(m,c)||u.unset&&b)i(d,l),r(u.silent?this._silent:h,l,!0);u.unset?i(p,l):r(p,l,c),!_.isEqual(g,c)||b!=w?(r(this.changed,l,c),u.silent||r(this._pending,l,!0)):(i(this.changed,l),i(this._pending,l))}return u.silent||this.change(u),this},has:function(e){return n(this.attributes,e)!=null},change:function(e){e||(e={});var s=this._changing;this._changing=!0;for(var o in t(this._silent))r(this._pending,o,!0);var u=_.extend({},e.changes,this._silent);this._silent={};for(var o in t(u))this.trigger("change:"+o,this,this.get(o),e);if(s)return this;while(!_.isEmpty(this._pending)){this._pending={},this.trigger("change",this,e);for(var o in t(this.changed)){if(n(this._pending,o)||n(this._silent,o))continue;i(this.change,o)}this._previousAttributes=_.clone(this.attributes)}return this._changing=!1,this},changedAttributes:function(e){if(!e)return this.hasChanged()?_.clone(t(this.changed)):!1;var n,r=!1,i=this._previousAttributes;for(var s in e){if(_.isEqual(i[s],n=e[s]))continue;(r||(r={}))[s]=n}return r}});e.DeepModel=s,typeof module!="undefined"&&(module.exports=s)}(Backbone),App={Model:{},Collection:{},View:{},instance:{}},App.Model.Generic=Backbone.DeepModel.extend({idAttribute:"_id"}),App.Model.Gallery=Backbone.Model.extend({urlRoot:"/api/gallery"}),App.Model.Project=App.Model.Generic.extend({urlRoot:"/api/projects"}),App.Collection.PicasaAlbumPictures=Backbone.Collection.extend({model:Backbone.DeepModel,initialize:function(e,t){this.albumId=t.albumId},url:function(){return"http://picasaweb.google.com/data/feed/api/user/"+App.Configuration.picasa.userId+"/albumid/"+this.albumId+"?alt=json&fields=entry(summary,content)"+"&uid="+(new Date).getTime()},parse:function(e){var t,n,r;return _.map(e.feed.entry,function(e){return t=e.content.src,n=t.lastIndexOf("/"),r=/\[en\]\s*(.+?)\s*\[ro\]\s*(.+)/i.exec(e.summary.$t.trim()),{urlPrefix:t.substring(0,n),fileName:t.substring(n+1),title:{en:r?r[1]:null,ro:r?r[2]:null}}})}}),App.Collection.PicasaProjectAlbums=Backbone.Collection.extend({url:function(){return"http://picasaweb.google.com/data/feed/api/user/"+App.Configuration.picasa.userId+"?alt=json&fields=entry(gphoto:id,title,published)"+"&uid="+(new Date).getTime()},parse:function(e){var t=[],n;return _.each(e.feed.entry,function(e){n=/^\[project\]\s*(.*)$/i.exec(e.title.$t.trim()),n&&t.push({id:e.gphoto$id.$t,title:n[1],date:e.published.$t})}),t}}),App.Collection.Projects=Backbone.Collection.extend({model:App.Model.Generic,url:"/api/projects"}),App.View.Gallery=Backbone.View.extend({el:"#gallery",initialize:function(){var e=this;_.bindAll
(e,"render"),e.model.on("change",e.showPicture,e),e.currentPictureIndex=0,e.model.set("id",1),e.model.fetch({success:e.render,error:function(){e.options.eventBus.trigger("message","error","Cannot load gallery!")}})},events:{"click button.btn-refresh":"refresh","click button.btn-prev":"prev","click button.btn-next":"next"},refresh:function(){var e=this,t=e.options.eventBus,n=new App.Collection.PicasaAlbumPictures([],{albumId:App.Configuration.picasa.galleryAlbumId});t.trigger("message","start"),n.fetch({success:function(){e.model.set("pictures",n.models.map(function(e){return e.attributes})),e.model.save(null,{success:function(){t.trigger("message","success"),e.currentPictureIndex=0,e.render()},error:function(){t.trigger("message","error","Cannot save gallery!")}})},error:function(){t.trigger("message","error","Cannot get pictures from Picasa!")}})},prev:function(){this.currentPictureIndex--,this.render()},next:function(){this.currentPictureIndex++,this.render()},render:function(){var e=this,t=e.model.get("pictures").length,n=t?e.model.get("pictures")[e.currentPictureIndex]:null,r=t?n.urlPrefix+"/s220/"+n.fileName:"/images/admin-gallery-img-empty.png",i=t?"["+(e.currentPictureIndex+1)+" of "+t+"]":"[no pictures]",s=$("button.btn-prev",e.$el),o=$("button.btn-next",e.$el);!t||e.currentPictureIndex===0?s.attr("disabled","disabled"):s.removeAttr("disabled"),!t||e.currentPictureIndex===t-1?o.attr("disabled","disabled"):o.removeAttr("disabled"),$(".picture-content",e.$el).css("background-image","url('"+r+"')").text(i)}}),App.View.MessageBox=Backbone.View.extend({el:"#message-box",initialize:function(){var e=this;_.bindAll(e,"show"),e.options.eventBus.on("message",e.show,e)},show:function(e,t){var n=$(window),r=this.$el;e=="start"&&(t="Please wait..."),e=="success"&&t==null?r.stop().fadeOut("fast"):($(".inner",r).text(t),r.stop().attr("class",e).css({left:(n.width()-r.outerWidth(!0))/2+"px",display:"block"}))},events:{click:function(){this.$el.hasClass("start")||this.$el.fadeOut("fast")}}}),App.View.ProjectEditor=Backbone.View.extend({el:"#project-editor",initialize:function(){var e=this;e.contentPicsTmpl=_.template($("#content-pics-tmpl").html()),_.bindAll(e,"updateForm","updateModel","clearPictures","showPictures","startNewProject"),e.options.eventBus.on("newproject",e.startNewProject,e),e.options.eventBus.on("loadproject",e.loadProject,e)},events:{"click button.btn-save":"saveProject","click button.btn-delete":"deleteProject","click button.btn-pictures":"reloadPictures"},updateForm:function(){var e=this.model;$(".title span",this.$el).text("Editing "+(e.isNew()?"new project":"project: "+e.get("content.en.title"))),$("#title-en").val(e.get("content.en.title")).toggleClass("error",e.get("content.en.title")===""),$("#description-en").val(e.get("content.en.description")).toggleClass("error",e.get("content.en.description")===""),$("#title-ro").val(e.get("content.ro.title")).toggleClass("error",e.get("content.ro.title")===""),$("#description-ro").val(e.get("content.ro.description")).toggleClass("error",e.get("content.ro.description")===""),$(".btn-delete",this.$el).css("display",e.isNew()?"none":"block")},updateModel:function(){this.model.set({"content.en.title":$("#title-en").val().trim(),"content.en.description":$("#description-en").val().trim(),"content.ro.title":$("#title-ro").val().trim(),"content.ro.description":$("#description-ro").val().trim()})},clearPictures:function(){$(".cover-picture .picture-content",this.$el).css("background-image","url('/images/admin-project-img-empty.png')"),$(".content-pictures",this.$el).empty()},showPictures:function(){var e=this,t=e.model,n=$(".content-pictures",e.$el);t.has("coverPicture")&&$(".cover-picture .picture-content",e.$el).css("background-image","url('"+t.get("coverPicture.urlPrefix")+"/s100-c/"+t.get("coverPicture.fileName")+"')"),t.has("contentPictures")&&_.each(t.get("contentPictures"),function(t,r){n.append(e.contentPicsTmpl({urlPrefix:t.urlPrefix,fileName:t.fileName,number:r+1}))})},startNewProject:function(){var e=this;e.model.clear(),e.updateForm(),e.clearPictures(),$("#title-en",e.$el).focus()},loadProject:function(e){var t=this,n=t.options.eventBus;t.model.clear(),t.updateForm(),t.clearPictures(),t.model.set("_id",e),n.trigger("message","start"),t.model.fetch({success:function(){t.updateForm(),t.showPictures(),n.trigger("message","success"),n.trigger("projectchanged",t.model.id)},error:function(){n.trigger("message","error","Cannot load project!")}})},saveProject:function(){var e=this,t=e.options.eventBus;e.updateModel(),e.model.get("content.en.title")==""?t.trigger("message","error","English title cannot be empty!"):(e.model.set("urlSuffix",e.model.get("content.en.title").replace(/[^\w]+/g,"_").toLowerCase()),t.trigger("message","start"),e.model.save(null,{success:function(){e.updateForm(),t.trigger("message","success"),t.trigger("projectchanged",e.model.id)},error:function(){t.trigger("message","error","Cannot save project!")}}))},deleteProject:function(){var e=this,t=e.options.eventBus;t.trigger("message","start"),e.model.destroy({success:function(){e.startNewProject(),t.trigger("message","success"),t.trigger("projectchanged")},error:function(){t.trigger("message","error","Cannot delete project!")}})},reloadPictures:function(){var e=this,t=e.options.eventBus,n=new App.Collection.PicasaProjectAlbums,r,i;e.clearPictures(),e.updateModel(),e.model.get("content.en.title")===""?t.trigger("message","error","Need English title to load pictures!"):(t.trigger("message","start"),n.fetch({success:function(){r=n.find(function(t){return t.get("title").toLowerCase()===e.model.get("content.en.title").toLowerCase()}),r?(e.model.set("date",r.get("date")),i=new App.Collection.PicasaAlbumPictures([],{albumId:r.id}),i.fetch({success:function(){var n=i.shift();e.model.set("coverPicture",{urlPrefix:n.get("urlPrefix"),fileName:n.get("fileName")}),e.model.set("contentPictures",i.map(function(e){return e.attributes})),t.trigger("message","success"),e.showPictures()},error:function(){t.trigger("message","error","Cannot reload pictures!")}})):t.trigger("message","error","No matching album found on Picasa!")},error:function(){t.trigger("message","error","Cannot reload pictures!")}}))}}),App.View.ProjectList=Backbone.View.extend({el:"#project-list",initialize:function(){var e=this;e.options.eventBus.on("projectchanged",e.onProjectChanged,e),e.collection.on("reset",e.render,e),e.collection.fetch()},render:function(){var e=this,t=$(".items",e.$el);t.empty(),e.collection.each(function(n){$("<a/>",{"class":n.id===e.currentProjectId?"project current":"project",href:"#project:"+n.id,text:n.get("content.en.title")}).appendTo(t)})},events:{"click a.project":"loadProject","click button.btn-add":"newProject"},loadProject:function(e){var t=$(e.target),n=t.attr("href"),r=n.substring(n.lastIndexOf(":")+1);this.options.eventBus.trigger("loadproject",r),e.preventDefault()},newProject:function(){this.currentProjectId=null,this.render(),this.options.eventBus.trigger("newproject")},onProjectChanged:function(e){this.currentProjectId=e,this.collection.fetch()}}),$(function(){var e=App.instance;e.adjustLayout=function(){$("body").css({height:$(window).height()})},$(window).resize(_.throttle(e.adjustLayout,200)),e.adjustLayout(),e.eventBus=_.extend({},Backbone.Events),e.projects=new App.Collection.Projects,e.currentProject=new App.Model.Project,e.gallery=new App.Model.Gallery,e.projectListView=new App.View.ProjectList({collection:e.projects,eventBus:e.eventBus}),e.projectEditorView=new App.View.ProjectEditor({model:e.currentProject,eventBus:e.eventBus}),e.galleryView=new App.View.Gallery({model:e.gallery,eventBus:e.eventBus}),e.messageBox=new App.View.MessageBox({eventBus:e.eventBus}),e.eventBus.trigger("newproject")});